# Start the postgres service and ensure it starts on boot.
# Copy the postgres dump from https://batman.usersys.redhat.com/pub/postgres.dump to the local system 
# and restore this file into the database.
---
- name: Deploy Apache Webserver
  hosts: all
  vars:
    server_name: ''
    document_root: ''
    server_admin: 'root@localhost'
    webpage_download_url: "http://batman.usersys.redhat.com/pub/index.html"
    vhost_template: "./vhost1.conf.j2"
    vhost_conf: 'vhost1.conf'
    apache_vhosts:
      - {server_name: "{{ server_name }}", document_root: "{{ document_root }}", server_admin: "{{ server_admin }}"}
    required_variables:
      - document_root
      - server_name
      - webpage_download_url
      - vhost_template
  tasks:
        
    - name: "Check if required_variables is set"
      fail:
        msg: "You must set {{ item }}"
      when: "{{ item }} is defined and {{ item }}|length == 0" 
      with_items:
        - "{{ required_variables }}"

    - name: Ensure Apache is installed
      package:
        name: httpd
        state: present
      when: ansible_os_family == "RedHat"

    - name: Create Virtual Host Document Root
      file:
        path: "{{ document_root }}"
        group: root
        mode: '0755'
        owner: root
        state: directory

    - name: Copy Webpage to server
      get_url:
        url: "{{ webpage_download_url }}"
        dest: "{{ document_root }}"
        mode: '0755'
        owner: apache
        group: apache

    - name: Create Virtual Host Configuration
      template:
        src: "{{ vhost_template }}"
        dest: /etc/httpd/conf.d/{{ vhost_conf }}

    - name: Start/Enable Apache Service
      systemd:
        state: restarted
        name: httpd
        enabled: yes